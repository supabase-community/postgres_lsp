name: Release PG_CLI

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  # Ultimately, we shouldn't ignore warnings.
  # We need to pass it as an ENV because inlining doesn't work on Windows.
  RUSTFLAGS: -A dead_code

jobs:
  build_and_test:
    strategy:
      matrix:
        config:
          - { os: ubuntu-latest, target: x86_64-unknown-linux-gnu }
          # - { os: ubuntu-latest, target: aarch64-unknown-linux-gnu }
          # - { os: macos-latest, target: x86_64-apple-darwin }
          # - { os: macos-latest, target: aarch64-apple-darwin }
          # - { os: windows-latest, target: x86_64-pc-windows-msvc }
          # - { os: windows-latest, target: aarch64-pc-windows-msvc }

    runs-on: ${{ matrix.config.os }}

    outputs:
      artifact_url: ${{ steps.upload-artifacts.outputs.artifact-url }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.config.target }}
      - uses: Swatinem/rust-cache@v2
        id: rust-cache
      - name: Have we hit Cache?
        run: |
          echo "Cache hit: ${{ steps.rust-cache.outputs.cache-hit }}"

      # running containers via `services` only works on linux
      # https://github.com/actions/runner/issues/1866
      - name: üêò Setup postgres
        uses: ikalnytskyi/action-setup-postgres@v7

      - name: üß™ Run Tests
        run: cargo test --release
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres

      - name: üõ†Ô∏è Run Build
        run: cargo build -p pg_cli --release --target ${{ matrix.config.target }}

      # It is not possible to return the artifacts from the matrix jobs individually: Matrix outputs overwrite each other.
      # A common workaround is to upload and download the resulting artifacts.
      - name: üëÜ Upload Artifacts
        id: upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pgcli_${{ matrix.config.target }}
          path: target/${{ matrix.config.target }}/release
          # The default compression level is 6; this took the binary down from 350 to 330MB.
          # It is recommended to use a lower level for binaries, since the compressed result is not much smaller,
          # and the higher levels of compression take much longer.
          compression-level: 2
          if-no-files-found: warn

  create_changelog_and_release:
    runs-on: ubuntu-latest
    needs: build_and_test # make sure that tests & build work correctly
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          # we need all commits to create a changelog
          fetch-depth: 0

      - name: üìù Create Changelog
        uses: orhun/git-cliff-action@v3
        id: create_changelog
        with:
          config: cliff.toml
          args: --bump --latest
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: üëá Download Artifacts
        uses: actions/download-artifact@v4
        id: download
        with:
          merge-multiple: true

      - name: Print Download Path
        run: echo "Downloaded Artifacts to ${{ steps.download.outputs.download-path }}"

      - name: üìÇ Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: ${{ steps.create_changelog.outputs.content }}
          tag_name: ${{ steps.create_changelog.outputs.version }}
          files: ${{ steps.download.outputs.download-path }}/*
